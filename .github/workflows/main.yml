name: "DMS GitOps Pipeline"

on:
  push:
    branches: [ main ]
  pull_request:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0

jobs:
  migration-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Terraform Setup
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Format
        run: terraform fmt -check

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        env:
          TF_VAR_onprem_mysql_password: ${{ secrets.MYSQL_PASSWORD }}
          TF_VAR_ssh_key_name: ${{ secrets.SSH_KEY_NAME }}

      - name: Terraform Apply
        id: tf
        run: |
          terraform apply -auto-approve tfplan
          echo "DMS_TASK_ARN=$(terraform output -raw dms_replication_task_arn)" >> $GITHUB_OUTPUT
      
      - name: Export Terraform outputs
        run: |
          echo "ONPREM_SECRET_ARN=$(terraform output -raw onprem_secret_arn)" >> $GITHUB_ENV

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible AWS EC2 Inventory Plugin
        run: ansible-galaxy collection install amazon.aws

      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i ansible/inventory.aws_ec2.yml ansible/playbook.yml \
          --extra-vars "mysql_password=${{ secrets.MYSQL_PASSWORD }}" \
          --forks 5 -vv
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

      - name: Run DMS Assessment
        run: |
          aws dms start-replication-task-assessment-run \
            --replication-task-arn "${{ steps.tf.outputs.DMS_TASK_ARN }}" \
            --assessment-run-name "assessment-${GITHUB_RUN_ID}" \
            --service-access-role-arn "$(terraform output -raw dms_assessment_role_arn)" \
            --result-location-bucket "${{ secrets.ASSESSMENT_S3_BUCKET }}" \
            --result-location-folder "assessments/${GITHUB_RUN_ID}/"

      - name: Start DMS Replication Task
        run: |
          aws dms start-replication-task \
            --replication-task-arn "${{ steps.tf.outputs.DMS_TASK_ARN }}" \
            --start-replication-task-type start-replication \
            --region ${{ env.AWS_REGION }}
